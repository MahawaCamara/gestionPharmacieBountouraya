{% extends 'base_admin.html' %}

{% block title %}Tableau de bord{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <h1 class="h2 mb-4 text-primary">Tableau de bord</h1>

    <!-- Bouton d'impression -->
    <div class="d-flex justify-content-end px-4 no-print">
        <button class="btn btn-secondary mb-3" onclick="window.print()">
            üñ®Ô∏è Imprimer le tableau de bord
        </button>
    </div>

    <!-- Cartes de statistiques -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6">
            <div class="card shadow-sm border-0 rounded-3">
                <div class="card-body">
                    <i class="fa fa-hospital fa-3x text-primary"></i>
                    <h5 class="card-title text-center">Pharmacies</h5>
                    <h3 class="text-center">{{ pharmacies }}</h3>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="card shadow-sm border-0 rounded-3">
                <div class="card-body">
                    <i class="fa fa-boxes fa-3x text-info"></i>
                    <h5 class="card-title text-center">Produits</h5>
                    <h3 class="text-center">{{ produits }}</h3>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="card shadow-sm border-0 rounded-3">
                <div class="card-body">
                    <i class="fa fa-users fa-3x text-success"></i>
                    <h5 class="card-title text-center">Utilisateurs</h5>
                    <h3 class="text-center">{{ utilisateurs }}</h3>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="card shadow-sm border-0 rounded-3">
                <div class="card-body">
                    <i class="fa fa-user-check fa-3x text-warning"></i>
                    <h5 class="card-title text-center">Abonnements</h5>
                    <h3 class="text-center">{{ abonnements }}</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Graphiques -->
    <h3 class="mb-4 text-secondary">Statistiques de la derni√®re semaine</h3>

    <div class="row">
        <div class="col-md-4 mb-4">
            <div class="card shadow-sm border-0 rounded-3">
                <div class="card-body">
                    <h5 class="card-title">Pharmacies par semaine</h5>
                    <canvas id="pharmacyChart"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-4 mb-4">
            <div class="card shadow-sm border-0 rounded-3">
                <div class="card-body">
                    <h5 class="card-title">Disponibilit√©s par semaine</h5>
                    <canvas id="productChart"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-4 mb-4">
            <div class="card shadow-sm border-0 rounded-3">
                <div class="card-body">
                    <h5 class="card-title">Abonnements par semaine</h5>
                    <canvas id="subscriptionChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Styles pour impression -->
<style>
@media print {
    .no-print, nav, header, footer, .sidebar {
        display: none !important;
    }

    .chart-print-image {
        max-width: 100%;
        margin: 1rem auto;
        display: block;
    }

    canvas {
        display: none !important;
    }

    .card {
        page-break-inside: avoid;
    }
}
</style>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const pharmacyCtx = document.getElementById('pharmacyChart').getContext('2d');
const productCtx = document.getElementById('productChart').getContext('2d');
const subscriptionCtx = document.getElementById('subscriptionChart').getContext('2d');

const pharmacyChart = new Chart(pharmacyCtx, {
    type: 'pie',
    data: {
        labels: {{ pharmacy_data.labels|safe }},
        datasets: [{
            label: 'Pharmacies',
            data: {{ pharmacy_data.data|safe }},
            backgroundColor: ['#007BFF', '#00BFFF', '#5C6BC0', '#3D5AFE', '#1976D2']
        }]
    },
    options: { responsive: true }
});

const productChart = new Chart(productCtx, {
    type: 'pie',
    data: {
        labels: {{ product_data.labels|safe }},
        datasets: [{
            label: 'Disponibilit√©s',
            data: {{ product_data.data|safe }},
            backgroundColor: ['#42A5F5', '#1E88E5', '#1976D2', '#1565C0']
        }]
    },
    options: { responsive: true }
});

const subscriptionChart = new Chart(subscriptionCtx, {
    type: 'pie',
    data: {
        labels: {{ subscription_data.labels|safe }},
        datasets: [{
            label: 'Abonnements',
            data: {{ subscription_data.data|safe }},
            backgroundColor: ['#66BB6A', '#81C784', '#A5D6A7']
        }]
    },
    options: { responsive: true }
});

// Impression : canvas -> image
document.addEventListener("DOMContentLoaded", function () {
    const canvasToImage = (canvas) => {
        const img = document.createElement("img");
        img.src = canvas.toDataURL("image/png");
        img.className = "chart-print-image img-fluid my-3";
        canvas.parentNode.insertBefore(img, canvas.nextSibling);
    };

    window.onbeforeprint = () => {
        setTimeout(() => {
            document.querySelectorAll("canvas").forEach(canvas => {
                if (!canvas.nextElementSibling || !canvas.nextElementSibling.classList.contains("chart-print-image")) {
                    canvasToImage(canvas);
                }
                canvas.style.display = "none";
            });
        }, 500);
    };

    window.onafterprint = () => {
        document.querySelectorAll(".chart-print-image").forEach(img => img.remove());
        document.querySelectorAll("canvas").forEach(canvas => {
            canvas.style.display = "block";
        });
    };
});
</script>
{% endblock %}
